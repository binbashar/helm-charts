version: 2

jobs:
  release-patch-with-changelog:
    machine:
      image: ubuntu-1604:201903-01
      docker_layer_caching: true

    steps:
      - checkout

      - add_ssh_keys:
          fingerprints:
            - "b8:f0:94:19:0e:03:4c:b0:66:1b:40:7a:f5:90:5c:47"

      - run: pwd

      - run: ls -ltra

      - run:
          name: release-patch-with-changelog-circleci
          command: |
            if git status | grep 'nothing to commit, working tree clean'; then
              echo "==============================================================================================="
              echo "release-patch-with-changelog-circleci"
              echo "==============================================================================================="
              make release-patch-with-changelog-circleci
            else
              echo "==============================================================================================="
              echo "Changes in working directory pending to be pushed - please check 'git status' cmd output below "
              echo "==============================================================================================="
              echo "$(git status)"
              echo "==============================================================================================="
            fi

      - run:
          name: make changelog-patch && git add && git commit && make release-patch
          command: make release-patch-with-changelog

workflows:
  version: 2
  changelog_and_release:
    jobs:
      - chagelog-patch